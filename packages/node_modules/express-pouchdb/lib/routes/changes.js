"use strict";

const utils = require('../utils');

module.exports = function (app) {
  utils.requires(app, 'routes/db');

  // Monitor database changes
  function changes(req, res) {

    utils.setJsonOrPlaintext(res);

    if (req.query.limit < 1) {
      req.query.limit = 1;
    }

    // api.changes expects a property `query_params`
    // This is a pretty inefficient way to do it.. Revisit?
    req.query.query_params = JSON.parse(JSON.stringify(req.query));

    req.query = utils.makeOpts(req, req.query);

    if (req.body && req.body.doc_ids) {
      req.query.doc_ids = req.body.doc_ids;
    }

    if (req.query.feed === 'continuous' || req.query.feed === 'longpoll') {
      let heartbeatInterval;
      // 60000 is the CouchDB default
      // TODO: figure out if we can make this default less aggressive
      const heartbeat = (typeof req.query.heartbeat === 'number') ?
        req.query.heartbeat : 6000;
      let written = false;
      heartbeatInterval = setInterval(() => {
        written = true;
        res.write('\n');
        //  TODO: может неправ
        if (res.flush) { res.flush(); }
      }, heartbeat);

      const cleanup = () => {
        if (heartbeatInterval) {
          clearInterval(heartbeatInterval);
        }
      };

      if (req.query.feed === 'continuous') {
        req.query.live = req.query.continuous = true;
        req.db.changes(req.query).on('change', (change) => {
          written = true;
          utils.writeJSON(res, change);
        }).on('error', (err) => {
          if (!written) {
            utils.sendError(res, err);
          } else {
            res.end();
          }
          cleanup();
        });
      } else { // longpoll
        // first check if there are >0. if so, return them immediately
        req.query.live = req.query.continuous = false;
        req.db.changes(req.query).then(complete => {
          if (complete.results.length) {
            utils.writeJSON(res, complete);
            res.end();
            cleanup();
          } else { // do the longpolling
            // mimicking CouchDB, start sending the JSON immediately
            res.write('{"results":[\n');
            req.query.live = req.query.continuous = true;
            let changes = req.db.changes(req.query)
              .on('change', (change) => {
                utils.writeJSON(res, change);
                res.write(`],\n"last_seq":${change.seq}}\n`);
                res.end();
                changes.cancel();
                cleanup();
                req.connection.removeListener('close', cancelChanges);
              }).on('error', (err) => {
                // shouldn't happen
                console.log(err);
                res.end();
                cleanup();
                req.connection.removeListener('close', cancelChanges);
              }).on('complete', () => {
                cleanup();
                req.connection.removeListener('close', cancelChanges);
              });

            var cancelChanges = function () {
              changes.cancel();
            };

            req.connection.on('close', cancelChanges);
          }
        }, (err) => {
          if (!written) {
            utils.sendError(res, err);
          }
          cleanup();
        });
      }
    } else { // straight shot, not continuous
      req.db.changes(req.query).then(response => {
        utils.sendJSON(res, 200, response);
      }).catch(err => {
        utils.sendError(res, err);
      });
    }
  }
  app.get('/:db/_changes', changes);
  app.post('/:db/_changes', utils.jsonParser, changes);
};
